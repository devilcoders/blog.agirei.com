<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link href="http://feeds.feedburner.com/pzol-agirei" rel="alternate" title="Agirei by pzol" type="application/rss+xml" />
    <link rel="stylesheet" type="text/css" href="/assets/stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="/assets/stylesheets/syntax.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="/assets/stylesheets/print.css" media="print" />
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>Always tell a story - blog.agirei.com by pzol</title>

    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
    <script>(function(d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return;
      js = d.createElement(s); js.id = id;
      js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));</script>
  </head>

  <body>
    <div id="container">
      <div class="inner">
        <header>
          <a href="/">
            <h1>ædʒirei</h1>
          </a>
          <h2>pzol blogging (maybe)</h2>
          <hr>
        </header>

        
  <section class="post">
    <h1>Always tell a story</h1>
    <aside>
      <p class="date">February 9, 2013</p>
      <p class="author">Piotr Zolnierek</p>
      <p class="tags"><a href="/categories/hexagonal.html">hexagonal</a>, <a href="/categories/di.html">di</a>, <a href="/categories/ioc.html">ioc</a>, <a href="/categories/srp.html">srp</a>, <a href="/categories/use case.html">use case</a></p>
    </aside>
    <article>
      <p>Creating many smaller classes each responsible for a single thing, I often end up having something at the top of the food chain, which needs to control the whole use case.</p>

<p>Enter the <strong>use case class</strong> or <strong>user story</strong>. When we talk about such entities at work (<a href="http://www.anixe.pl">anixe</a>) we often speak about the head of control, which is a nice metaphor, as this gives the impression that it is in charge of the flow, which is exactly what I want it to be.</p>

<!-- more -->

<h2>The user story</h2>

<p>Imagine we have a common scenario where a user submits a web form which contains his billing data and the items he ordered. Let's assumed we have captured the request variables in two variables: billing and items.</p>

<pre><code class="language-ruby"><span class="k">class</span> <span class="nc">UserPostsOrder</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">validator</span><span class="o">=</span><span class="no">OrderValidator</span><span class="o">.</span><span class="n">new</span><span class="p">,</span> <span class="n">repository</span><span class="o">=</span><span class="no">OrderRepository</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>
    <span class="vi">@validator</span><span class="p">,</span> <span class="vi">@repository</span> <span class="o">=</span> <span class="n">validator</span><span class="p">,</span> <span class="n">repository</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="n">billing</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>
    <span class="vi">@validator</span><span class="o">.</span><span class="n">validate</span> <span class="n">billing</span><span class="p">,</span> <span class="n">items</span>
    <span class="vi">@repository</span><span class="o">.</span><span class="n">save</span> <span class="n">billing</span><span class="p">,</span> <span class="n">items</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>

<p>The initialize method sets up the dependencies and by my convention is the only method which is allowed to modify the class's internal state (in practice this means that only here instance variables may be modified). Collaborators (Adapters) passed in as dependencies may receive messages which modify the outside world.</p>

<p>The post methods gets the raw, i.e. unvalidated data from the outside world (the web-ui adapter, aka Rails, Padrino, Sinatra etc).</p>

<h2>Good story names</h2>

<p>Other examples of good class names in this convention might be:</p>

<ul>
<li>UserSubscribesNewsletter</li>
<li>AdminCreatesUser</li>
<li>AdminResetsPassword</li>
<li>UserReceivesEmail</li>
</ul><h2>Stories within stories</h2>

<p>Let's have a look at the last example and make it a bit more complicated. Now the big story contains a smaller one - UserReceivesEmail.</p>

<pre><code class="language-ruby"><span class="k">class</span> <span class="nc">UserPostsOrder</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">validator</span><span class="o">=</span><span class="no">OrderValidator</span><span class="o">.</span><span class="n">new</span><span class="p">,</span> <span class="n">repository</span><span class="o">=</span><span class="no">OrderRepository</span><span class="o">.</span><span class="n">new</span><span class="p">,</span> <span class="n">mailer</span><span class="o">=</span><span class="no">Mailer</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>
    <span class="vi">@validator</span><span class="p">,</span> <span class="vi">@repository</span><span class="p">,</span> <span class="vi">@mailer</span> <span class="o">=</span> <span class="n">validator</span><span class="p">,</span> <span class="n">repository</span><span class="p">,</span> <span class="n">mailer</span>
    <span class="vi">@prepare_order</span>       <span class="o">=</span> <span class="no">PrepareOrder</span><span class="o">.</span><span class="n">new</span>
    <span class="vi">@confirmation_email</span>  <span class="o">=</span> <span class="no">UserReceivesOrderConfirmationEmail</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@mailer</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="n">billing</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>
    <span class="vi">@validator</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">billing</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="vi">@prepare_order</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">billing</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>
    <span class="vi">@repository</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
    <span class="vi">@confirmation_email</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>

<p>The main method <code>post</code> reads like prose, it shows you step by step what happens, you should be even able to show this to non-techie people and they will understand it.</p>

<p>If anything goes wrong, then errors will be raised in the collaborators - repository, validator, so that the flow will stop.</p>

<p>Please take notice, that the <code>#post</code> method should ideally only change when the business logic changes.</p>

<p>I'll write more about organizing dependencies in another upcoming post.</p>

<h2>File organization</h2>

<p>The story lives in its own file, all smaller classes it needs are in a subfolder, just like a little gem.</p>

<pre><code>└── lib
    └── hexagonal
        ├── user_posts_order
        │   ├── order_repository.rb     # database adapter
        │   ├── order_validator.rb
        │   ├── user_receivers_order_confirmation_email.rb
        │   └── prepare_order.rb
        └── user_posts_order.rb
</code></pre>

<h2>Story Reusability</h2>

<p>Breaking down the story into sub-stories and service classes with single responsibilities encourages reusability.</p>

<p>Once I need the <code>OrderRepository</code> also in another entity, I would push it up to the lib/hexagonal directory.</p>

<h2>Conclusion</h2>

<p>The user story should be in the center hexagon, housing your domain logic. I recommend creating them on a per use case basis, similar to a context in DCI. For a small app this might be overkill, however if you are planning for a medium+ application, which will be maintained for a long time, then it's worth investing the time to organize your architecture this way.</p>

<p>This is post is part of a series about creating maintainable software with a hexagonal arcitecture. See also</p>

<ul>
<li><a href="/2013/01/depend-on-abstractions-only">Depend on abstractions only</a></li>
</ul>
    </article>
  </section>

  <section class="social">
    <a href="https://twitter.com/pzol" class="twitter-follow-button" data-show-count="false">Follow @pzol</a>
    <a href="https://twitter.com/share" class="twitter-share-button" data-via="pzol">Tweet</a>
    <div id="fb-root"></div>
    <div class="fb-like" data-send="false" data-layout="button_count" data-width="450" data-show-faces="false"></div>
  </section>

  <section class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'agirei';

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </section>


        <footer>
          blog.agirei.com is maintained by <a href="https://github.com/pzol">pzol</a><br>
          Tactile theme by <a href="http://twitter.com/jasonlong">Jason Long</a>.
        </footer>

        <script type="text/javascript">
          var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
          document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
        </script>
        <script type="text/javascript">
          try {
            var pageTracker = _gat._getTracker("UA-4944917-10");
          pageTracker._trackPageview();
          } catch(err) {}
        </script>

      </div>
    </div>
  </body>
</html>

