<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link href="http://feeds.feedburner.com/pzol-agirei" rel="alternate" title="Agirei by pzol" type="application/rss+xml" />
    <link rel="stylesheet" type="text/css" href="/assets/stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="/assets/stylesheets/syntax.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="/assets/stylesheets/print.css" media="print" />
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>Taming the Capybara - blog.agirei.com by pzol</title>

    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
    <script>(function(d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return;
      js = d.createElement(s); js.id = id;
      js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));</script>
  </head>

  <body>
    <div id="container">
      <div class="inner">

        <header>
          <a href="/">
            <h1>blog.agirei.com</h1>
          </a>
          <h2>pzol blogging (maybe)</h2>
        </header>

        <hr>

        <section id="main_content">
          
  <div class='post'>
    <h1>Taming the Capybara</h1>
    <aside>Posted at: 2012-02-02 10:00</aside>
    <article>
      <p>Recently I work a lot on Acceptance Tests and how to write them in a clean way.
When working with <a href="https://www.relishapp.com/rspec">RSpec</a> and <a href="https://github.com/jnicklas/capybara/">Capybara</a> I often see people wanting to go to a page and then do a couple of tests. The intent is to go to the site, login, then <em>describe</em> what they see, which is good practice (at least in theory). </p>

<!-- more -->

<p>Something like this (which I consider spaghetti coding anyway, but nice for the purpose of illustration):</p>

<pre><code class="ruby">describe 'My Page', :type =&gt; :acceptance do
  before(:all) do 
    visit '/'
    fill_in 'email', :with =&gt; 'pzolnierek@gmail.com'
    fill_in 'password', :with =&gt; 'passw0rd'
    click_button 'login'
  end

  it 'shows a logout button' do
    page.should have_link 'logout'
  end

  it 'shows a product information box' do
    page.should have_selector '#infoBox'
  end
end
</code></pre>

<p>Trouble is that Capybara will by default reset your session after each test. Bummer! 
If you look at the Capybara source code you will find this:</p>

<p><code>ruby https://github.com/jnicklas/capybara/blob/master/lib/capybara/rspec.rb
...
config.after do
    if self.class.include?(Capybara::DSL)
      Capybara.reset_sessions!
      Capybara.use_default_driver
    end
  end
...
</code></p>

<h2>The OO Solution</h2>

<p>I am currently working on another more longish article which will be about <strong>Beautiful Acceptance Tests</strong> where I use an object oriented way to  write acceptance tests, but here is a tip from it.</p>

<p>If you want full control do the Capybara wire-up yourself. </p>

<p>First we create a context object, which will hold our session.</p>

<p><code>ruby test_user.rb
class TestUser
  include RSpec::Matchers
  include Capybara::DSL
  include Capybara::RSpecMatchers
end
</code></p>

<p>Now you can do testing like a Boss!</p>

<pre><code class="ruby">describe 'My Page' do
  attr_accessor :user
  before(:all) do
    @user = TestUser.new
    @user.visit '/'
  end

  it 'shows a logout button' do
    user.page.should have_link 'logout'
  end

  it 'shows a product information box' do
    user.page.should have_selector '#infoBox'
  end
end

</code></pre>

<p>Notice the missing <code>:type =&gt; :acceptance</code>. Here the <code>Capybara::Session</code> will be embedded in the TestUser instance, instead of the Nested class which is created by RSpec and thus will work across tests.</p>

<h2>The token authorization solution</h2>

<p>Another even faster to implement solution for some people is to have token authorization.</p>

<pre><code class="ruby">describe 'My Page' do
  before(:each) do
    visit '/?token=some-fancy-token-or-guid'
  end

  it 'shows a logout button' do
    page.should have_link 'logout'
  end

  it 'shows a product information box' do
    page.should have_selector '#infoBox'
  end
end
</code></pre>
    </article>
  </div>
  <section class="social">
    <a href="https://twitter.com/pzol" class="twitter-follow-button" data-show-count="false">Follow @pzol</a>
    <a href="https://twitter.com/share" class="twitter-share-button" data-via="pzol">Tweet</a>
    <div id="fb-root"></div>

  <div class="fb-like" data-send="false" data-layout="button_count" data-width="450" data-show-faces="false"></div>

  </section>

  <section class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'agirei';

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </section>

        </section>

        <footer>
          blog.agirei.com is maintained by <a href="https://github.com/pzol">pzol</a><br>
          Tactile theme by <a href="http://twitter.com/jasonlong">Jason Long</a>.
        </footer>

        <script type="text/javascript">
          var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
          document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
        </script>
        <script type="text/javascript">
          try {
            var pageTracker = _gat._getTracker("UA-4944917-10");
          pageTracker._trackPageview();
          } catch(err) {}
        </script>

      </div>
    </div>
  </body>
</html>

